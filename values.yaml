# Default values for prometheus.
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

namespace: emso-monitoring
# nodeName: cluster-sn-ng-ingres-bazxvbzp64mx-node-0
image:
  repository: prom/prometheus
  pullPolicy: IfNotPresent
  tag: v2.51.1

reloaderImage:
  repository: ghcr.io/prometheus-operator/prometheus-config-reloader
  pullPolicy: IfNotPresent
  tag: v0.72.0

service:
  type: NodePort
  port: 9090
  nodePort: 30900

resources: {}
  # limits:
  #   cpu: 100m
  #   memory: 128Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

podAnnotations:
  sidecar.istio.io/inject: "false"

rbac:
  create: true

configMap:
  alertingRules:
    groups:
      - name: Rules
        rules:
          - alert: "(POD) Cáº£nh bÃ¡o RAM"
            expr: 'sum by (pod, namespace) (sum by (container, pod, namespace) (container_memory_usage_bytes{container!~"elasticsearch", namespace=~".+"}) / sum by (container, pod, namespace) (kube_pod_container_resource_limits{namespace=~".+", resource="memory"}) * 100 > 50 or sum by (container, pod, namespace) (container_memory_usage_bytes{container="elasticsearch", namespace=~".+"}) / sum by (container, pod, namespace) (kube_pod_container_resource_limits{namespace=~".+", resource="memory"}) * 100 > 80 or sum by (pod, namespace) ( rate(container_cpu_usage_seconds_total{namespace=~".+"}[1m])) * 100000 / (sum(container_spec_cpu_quota{namespace=~".+"}) by (pod, namespace)) > 0.5)'
            labels:
              severity: Kháº©n cáº¥p
              app_type: Application
              category: kubernetes
              instance: "{{ $labels.pod }}"
            annotations:
              summary: "TÃ i nguyÃªn tÄƒng"
              description: "cáº£nh bÃ¡o"

          - alert: Node KhÃ´ng Sáºµn SÃ ng
            expr: kube_node_status_condition{condition="Ready",status="true"} == 0
            for: 10m
            labels:
              severity: critical
            annotations:
              summary: "Node Kubernetes khÃ´ng sáºµn sÃ ng (mÃ¡y chá»§: {{ $labels.node }})"
              description: >
                Node {{ $labels.node }} Ä‘Ã£ khÃ´ng á»Ÿ tráº¡ng thÃ¡i sáºµn sÃ ng trong Ã­t nháº¥t 10 phÃºt.
                CÃ³ thá»ƒ node Ä‘Ã£ bá»‹ lá»—i, máº¥t káº¿t ná»‘i, hoáº·c Ä‘ang bá»‹ quÃ¡ táº£i.

                ğŸ” GiÃ¡ trá»‹: {{ $value }}
                ğŸ·ï¸ NhÃ£n: {{ $labels }}
                ğŸ“… Thá»i gian: {{ $value | humanizeTimestamp }}

          - alert: Node bá»‹ DiskPressure
            expr: kube_node_status_condition{condition="DiskPressure",status="true"} == 1
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "âš ï¸ Node Kubernetes Ä‘ang Ä‘áº§y Ä‘Ä©a ({{ $labels.instance }})"
              description: >
                Node {{ $labels.node }} Ä‘ang á»Ÿ tráº¡ng thÃ¡i *DiskPressure*, tá»©c lÃ  há»‡ thá»‘ng phÃ¡t hiá»‡n á»• Ä‘Ä©a gáº§n Ä‘áº§y hoáº·c khÃ´ng cÃ²n Ä‘á»§ dung lÆ°á»£ng Ä‘á»ƒ hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh.

                â±ï¸ TÃ¬nh tráº¡ng kÃ©o dÃ i Ã­t nháº¥t 2 phÃºt.

                ğŸ“Š GiÃ¡ trá»‹: {{ $value }}
                ğŸ·ï¸ NhÃ£n: {{ $labels }}
                ğŸ“… Thá»i gian: {{ $value | humanizeTimestamp }}

          - alert: Container bá»‹ OOMKilled
            expr: (kube_pod_container_status_restarts_total - kube_pod_container_status_restarts_total offset 10m >= 1)
              and ignoring (reason)
              min_over_time(kube_pod_container_status_last_terminated_reason{reason="OOMKilled"}[10m]) == 1
            for: 0m
            labels:
              severity: warning
            annotations:
              summary: "âš ï¸ Container bá»‹ thiáº¿u bá»™ nhá»› (OOMKilled)"
              description: >
                Container `{{ $labels.container }}` trong pod `{{ $labels.namespace }}/{{ $labels.pod }}` Ä‘Ã£ bá»‹ há»‡ thá»‘ng dá»«ng do vÆ°á»£t quÃ¡ giá»›i háº¡n bá»™ nhá»› (OOMKilled) Ã­t nháº¥t 1 láº§n trong 10 phÃºt gáº§n Ä‘Ã¢y.

                ğŸ” Sá»‘ láº§n restart tÄƒng lÃªn trong khoáº£ng thá»i gian Ä‘Ã³.

                ğŸ“Š GiÃ¡ trá»‹: {{ $value }}
                ğŸ·ï¸ NhÃ£n: {{ $labels }}
                ğŸ“… Thá»i gian: {{ $value | humanizeTimestamp }}

          - alert: PVC Äang chá» Ä‘Æ°á»£c cáº¥p phÃ¡t
            expr: kube_persistentvolumeclaim_status_phase{phase="Pending"} == 1
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "âš ï¸ PVC Ä‘ang chá» Ä‘Æ°á»£c cáº¥p phÃ¡t (Pending)"
              description: >
                PersistentVolumeClaim `{{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }}` Ä‘Ã£ á»Ÿ tráº¡ng thÃ¡i *Pending* trong hÆ¡n 2 phÃºt.

                ğŸ“¦ Äiá»u nÃ y cÃ³ thá»ƒ khiáº¿n Pod khÃ´ng thá»ƒ khá»Ÿi Ä‘á»™ng do thiáº¿u storage.

                ğŸ“Š GiÃ¡ trá»‹: {{ $value }}
                ğŸ·ï¸ NhÃ£n: {{ $labels }}

          - alert: Volume Gáº§n Ä‘áº§y dung lÆ°á»£ng
            expr: kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes * 100 < 10
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "âš ï¸ Volume gáº§n Ä‘áº§y dung lÆ°á»£ng (cÃ²n dÆ°á»›i 10%)"
              description: >
                Má»™t volume Ä‘ang gáº§n Ä‘áº§y â€“ chá»‰ cÃ²n dÆ°á»›i 10% dung lÆ°á»£ng kháº£ dá»¥ng.

                Äiá»u nÃ y cÃ³ thá»ƒ gÃ¢y lá»—i ghi dá»¯ liá»‡u, crash á»©ng dá»¥ng hoáº·c dá»«ng Pod náº¿u vÆ°á»£t quÃ¡ giá»›i háº¡n.

                ğŸ“Š GiÃ¡ trá»‹: {{ $value }}%
                ğŸ·ï¸ NhÃ£n: {{ $labels }}

          - alert: StatefulSet khÃ´ng Ä‘á»§ Pod
            expr: kube_statefulset_replicas - kube_statefulset_status_replicas_ready > 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "â— StatefulSet khÃ´ng Ä‘á»§ Pod ({{ $labels.namespace }}/{{ $labels.statefulset }})"
              description: >
                StatefulSet `{{ $labels.namespace }}/{{ $labels.statefulset }}` Ä‘ang cÃ³ sá»‘ lÆ°á»£ng Pod sáºµn sÃ ng **Ã­t hÆ¡n** so vá»›i ká»³ vá»ng.

                ğŸ“¦ Sá»‘ Pod cáº§n: `kube_statefulset_replicas`
                âœ… Sá»‘ Pod sáºµn sÃ ng: `kube_statefulset_status_replicas_ready`

                CÃ³ thá»ƒ do lá»—i container, node thiáº¿u tÃ i nguyÃªn, hoáº·c PVC gáº·p sá»± cá»‘.

                ğŸ”¢ VALUE: {{ $value }}
                ğŸ·ï¸ LABELS: {{ $labels }}

          - alert: HPA khÃ´ng thá»ƒ scale thÃªm
            expr: (kube_horizontalpodautoscaler_spec_max_replicas - kube_horizontalpodautoscaler_status_desired_replicas)
                  * on (horizontalpodautoscaler,namespace)
                  (kube_horizontalpodautoscaler_status_condition{condition="ScalingLimited", status="true"} == 1) == 0
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "âš ï¸ HPA khÃ´ng thá»ƒ scale thÃªm ({{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler }})"
              description: >
                HorizontalPodAutoscaler `{{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler }}` Ä‘ang á»Ÿ tráº¡ng thÃ¡i *ScalingLimited*, tá»©c lÃ  khÃ´ng thá»ƒ má»Ÿ rá»™ng thÃªm sá»‘ Pod dÃ¹ cÃ³ nhu cáº§u.

                CÃ³ thá»ƒ do Ä‘Ã£ Ä‘áº¡t Ä‘áº¿n giá»›i háº¡n `maxReplicas`, tÃ i nguyÃªn cluster khÃ´ng Ä‘á»§, hoáº·c Pod khÃ´ng khá»Ÿi Ä‘á»™ng Ä‘Æ°á»£c.

                ğŸ“Š GiÃ¡ trá»‹: {{ $value }}
                ğŸ·ï¸ NhÃ£n: {{ $labels }}

          - alert: HPA Ä‘Ã£ Ä‘áº¡t Ä‘áº¿n giá»›i háº¡n tá»‘i Ä‘a sá»‘ Pod
            expr: (kube_horizontalpodautoscaler_status_desired_replicas >= kube_horizontalpodautoscaler_spec_max_replicas)
                  and (kube_horizontalpodautoscaler_spec_max_replicas > 1)
                  and (kube_horizontalpodautoscaler_spec_min_replicas != kube_horizontalpodautoscaler_spec_max_replicas)
            for: 2m
            labels:
              severity: info
            annotations:
              summary: "â„¹ï¸ HPA Ä‘Ã£ Ä‘áº¡t Ä‘áº¿n giá»›i háº¡n tá»‘i Ä‘a sá»‘ Pod"
              description: >
                HPA `{{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler }}` Ä‘Ã£ scale Ä‘áº¿n sá»‘ Pod tá»‘i Ä‘a Ä‘Æ°á»£c cáº¥u hÃ¬nh (`maxReplicas`).

                ğŸ‘‰ Äiá»u nÃ y cÃ³ thá»ƒ cho tháº¥y workload Ä‘ang cáº§n nhiá»u tÃ i nguyÃªn hÆ¡n, hoáº·c báº¡n nÃªn cÃ¢n nháº¯c nÃ¢ng `maxReplicas`.

                ğŸ“Š GiÃ¡ trá»‹: {{ $value }}
                ğŸ·ï¸ NhÃ£n: {{ $labels }}

          - alert: HPA Ä‘á»§ tÃ i nguyÃªn
            expr: max(
                    quantile_over_time(0.5, kube_horizontalpodautoscaler_status_desired_replicas[1d])
                    == kube_horizontalpodautoscaler_spec_min_replicas
                  ) by (horizontalpodautoscaler) > 3
            for: 0m
            labels:
              severity: info
            annotations:
              summary: "â„¹ï¸ HPA sá»­ dá»¥ng tháº¥p â€“ cÃ³ thá»ƒ dÆ° tÃ i nguyÃªn"
              description: >
                HorizontalPodAutoscaler `{{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler }}` Ä‘Ã£ hoáº¡t Ä‘á»™ng á»Ÿ má»©c tá»‘i thiá»ƒu (`minReplicas`) trong **Ã­t nháº¥t 50% thá»i gian cá»§a 1 ngÃ y qua**.

                ğŸ‘‰ Äiá»u nÃ y cÃ³ thá»ƒ cho tháº¥y á»©ng dá»¥ng Ä‘ang Ä‘Æ°á»£c phÃ¢n bá»• tÃ i nguyÃªn dÆ° thá»«a. CÃ¢n nháº¯c giáº£m sá»‘ lÆ°á»£ng replica hoáº·c tiáº¿t kiá»‡m chi phÃ­.

                ğŸ“Š GiÃ¡ trá»‹: {{ $value }}
                ğŸ·ï¸ NhÃ£n: {{ $labels }}

          - alert: POD khÃ´ng á»Ÿ tráº¡ng thÃ¡i hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng
            expr: sum by (namespace, pod, job) (kube_pod_status_phase{phase=~"Pending|Unknown|Failed"}) > 0
            for: 15m
            labels:
              severity: critical
            annotations:
              summary: "â— Pod khÃ´ng á»Ÿ tráº¡ng thÃ¡i hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng"
              description: >
                Pod `{{ $labels.namespace }}/{{ $labels.pod }}` Ä‘Ã£ á»Ÿ tráº¡ng thÃ¡i khÃ´ng hoáº¡t Ä‘á»™ng (Pending, Unknown hoáº·c Failed) liÃªn tá»¥c trong hÆ¡n 15 phÃºt.

                ğŸ“Š GiÃ¡ trá»‹: {{ $value }}
                ğŸ·ï¸ NhÃ£n: {{ $labels }}

persistence:
  enabled: false
  # storageClass: "-"
  # size: 8Gi