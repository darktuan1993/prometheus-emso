# Default values for prometheus.
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

namespace: emso-monitoring
# nodeName: cluster-sn-ng-ingres-bazxvbzp64mx-node-0
image:
  repository: prom/prometheus
  pullPolicy: IfNotPresent
  tag: v2.51.1

reloaderImage:
  repository: ghcr.io/prometheus-operator/prometheus-config-reloader
  pullPolicy: IfNotPresent
  tag: v0.72.0

service:
  type: NodePort
  port: 9090
  nodePort: 30900

resources: {}
  # limits:
  #   cpu: 100m
  #   memory: 128Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

podAnnotations:
  sidecar.istio.io/inject: "false"

rbac:
  create: true

configMap:
  alertingRules:
    groups:
      - name: Rules
        rules:
          - alert: "(POD) Cảnh báo RAM"
            expr: 'sum by (pod, namespace) (sum by (container, pod, namespace) (container_memory_usage_bytes{container!~"elasticsearch", namespace=~".+"}) / sum by (container, pod, namespace) (kube_pod_container_resource_limits{namespace=~".+", resource="memory"}) * 100 > 50 or sum by (container, pod, namespace) (container_memory_usage_bytes{container="elasticsearch", namespace=~".+"}) / sum by (container, pod, namespace) (kube_pod_container_resource_limits{namespace=~".+", resource="memory"}) * 100 > 80 or sum by (pod, namespace) ( rate(container_cpu_usage_seconds_total{namespace=~".+"}[1m])) * 100000 / (sum(container_spec_cpu_quota{namespace=~".+"}) by (pod, namespace)) > 0.5)'
            labels:
              severity: Khẩn cấp
              app_type: Application
              category: kubernetes
              instance: "{{ $labels.pod }}"
            annotations:
              summary: "Tài nguyên tăng"
              description: "cảnh báo"

          - alert: Node Không Sẵn Sàng
            expr: kube_node_status_condition{condition="Ready",status="true"} == 0
            for: 10m
            labels:
              severity: critical
            annotations:
              summary: "Node Kubernetes không sẵn sàng (máy chủ: {{ $labels.node }})"
              description: >
                Node {{ $labels.node }} đã không ở trạng thái sẵn sàng trong ít nhất 10 phút.
                Có thể node đã bị lỗi, mất kết nối, hoặc đang bị quá tải.

                🔎 Giá trị: {{ $value }}
                🏷️ Nhãn: {{ $labels }}
                📅 Thời gian: {{ $value | humanizeTimestamp }}

          - alert: Node bị DiskPressure
            expr: kube_node_status_condition{condition="DiskPressure",status="true"} == 1
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "⚠️ Node Kubernetes đang đầy đĩa ({{ $labels.instance }})"
              description: >
                Node {{ $labels.node }} đang ở trạng thái *DiskPressure*, tức là hệ thống phát hiện ổ đĩa gần đầy hoặc không còn đủ dung lượng để hoạt động ổn định.

                ⏱️ Tình trạng kéo dài ít nhất 2 phút.

                📊 Giá trị: {{ $value }}
                🏷️ Nhãn: {{ $labels }}
                📅 Thời gian: {{ $value | humanizeTimestamp }}

          - alert: Container bị OOMKilled
            expr: (kube_pod_container_status_restarts_total - kube_pod_container_status_restarts_total offset 10m >= 1)
              and ignoring (reason)
              min_over_time(kube_pod_container_status_last_terminated_reason{reason="OOMKilled"}[10m]) == 1
            for: 0m
            labels:
              severity: warning
            annotations:
              summary: "⚠️ Container bị thiếu bộ nhớ (OOMKilled)"
              description: >
                Container `{{ $labels.container }}` trong pod `{{ $labels.namespace }}/{{ $labels.pod }}` đã bị hệ thống dừng do vượt quá giới hạn bộ nhớ (OOMKilled) ít nhất 1 lần trong 10 phút gần đây.

                🔁 Số lần restart tăng lên trong khoảng thời gian đó.

                📊 Giá trị: {{ $value }}
                🏷️ Nhãn: {{ $labels }}
                📅 Thời gian: {{ $value | humanizeTimestamp }}

          - alert: PVC Đang chờ được cấp phát
            expr: kube_persistentvolumeclaim_status_phase{phase="Pending"} == 1
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "⚠️ PVC đang chờ được cấp phát (Pending)"
              description: >
                PersistentVolumeClaim `{{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }}` đã ở trạng thái *Pending* trong hơn 2 phút.

                📦 Điều này có thể khiến Pod không thể khởi động do thiếu storage.

                📊 Giá trị: {{ $value }}
                🏷️ Nhãn: {{ $labels }}

          - alert: Volume Gần đầy dung lượng
            expr: kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes * 100 < 10
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "⚠️ Volume gần đầy dung lượng (còn dưới 10%)"
              description: >
                Một volume đang gần đầy – chỉ còn dưới 10% dung lượng khả dụng.

                Điều này có thể gây lỗi ghi dữ liệu, crash ứng dụng hoặc dừng Pod nếu vượt quá giới hạn.

                📊 Giá trị: {{ $value }}%
                🏷️ Nhãn: {{ $labels }}

          - alert: StatefulSet không đủ Pod
            expr: kube_statefulset_replicas - kube_statefulset_status_replicas_ready > 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "❗ StatefulSet không đủ Pod ({{ $labels.namespace }}/{{ $labels.statefulset }})"
              description: >
                StatefulSet `{{ $labels.namespace }}/{{ $labels.statefulset }}` đang có số lượng Pod sẵn sàng **ít hơn** so với kỳ vọng.

                📦 Số Pod cần: `kube_statefulset_replicas`
                ✅ Số Pod sẵn sàng: `kube_statefulset_status_replicas_ready`

                Có thể do lỗi container, node thiếu tài nguyên, hoặc PVC gặp sự cố.

                🔢 VALUE: {{ $value }}
                🏷️ LABELS: {{ $labels }}

          - alert: HPA không thể scale thêm
            expr: (kube_horizontalpodautoscaler_spec_max_replicas - kube_horizontalpodautoscaler_status_desired_replicas)
                  * on (horizontalpodautoscaler,namespace)
                  (kube_horizontalpodautoscaler_status_condition{condition="ScalingLimited", status="true"} == 1) == 0
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "⚠️ HPA không thể scale thêm ({{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler }})"
              description: >
                HorizontalPodAutoscaler `{{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler }}` đang ở trạng thái *ScalingLimited*, tức là không thể mở rộng thêm số Pod dù có nhu cầu.

                Có thể do đã đạt đến giới hạn `maxReplicas`, tài nguyên cluster không đủ, hoặc Pod không khởi động được.

                📊 Giá trị: {{ $value }}
                🏷️ Nhãn: {{ $labels }}

          - alert: HPA đã đạt đến giới hạn tối đa số Pod
            expr: (kube_horizontalpodautoscaler_status_desired_replicas >= kube_horizontalpodautoscaler_spec_max_replicas)
                  and (kube_horizontalpodautoscaler_spec_max_replicas > 1)
                  and (kube_horizontalpodautoscaler_spec_min_replicas != kube_horizontalpodautoscaler_spec_max_replicas)
            for: 2m
            labels:
              severity: info
            annotations:
              summary: "ℹ️ HPA đã đạt đến giới hạn tối đa số Pod"
              description: >
                HPA `{{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler }}` đã scale đến số Pod tối đa được cấu hình (`maxReplicas`).

                👉 Điều này có thể cho thấy workload đang cần nhiều tài nguyên hơn, hoặc bạn nên cân nhắc nâng `maxReplicas`.

                📊 Giá trị: {{ $value }}
                🏷️ Nhãn: {{ $labels }}

          - alert: HPA đủ tài nguyên
            expr: max(
                    quantile_over_time(0.5, kube_horizontalpodautoscaler_status_desired_replicas[1d])
                    == kube_horizontalpodautoscaler_spec_min_replicas
                  ) by (horizontalpodautoscaler) > 3
            for: 0m
            labels:
              severity: info
            annotations:
              summary: "ℹ️ HPA sử dụng thấp – có thể dư tài nguyên"
              description: >
                HorizontalPodAutoscaler `{{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler }}` đã hoạt động ở mức tối thiểu (`minReplicas`) trong **ít nhất 50% thời gian của 1 ngày qua**.

                👉 Điều này có thể cho thấy ứng dụng đang được phân bổ tài nguyên dư thừa. Cân nhắc giảm số lượng replica hoặc tiết kiệm chi phí.

                📊 Giá trị: {{ $value }}
                🏷️ Nhãn: {{ $labels }}

          - alert: POD không ở trạng thái hoạt động bình thường
            expr: sum by (namespace, pod, job) (kube_pod_status_phase{phase=~"Pending|Unknown|Failed"}) > 0
            for: 15m
            labels:
              severity: critical
            annotations:
              summary: "❗ Pod không ở trạng thái hoạt động bình thường"
              description: >
                Pod `{{ $labels.namespace }}/{{ $labels.pod }}` đã ở trạng thái không hoạt động (Pending, Unknown hoặc Failed) liên tục trong hơn 15 phút.

                📊 Giá trị: {{ $value }}
                🏷️ Nhãn: {{ $labels }}

persistence:
  enabled: false
  # storageClass: "-"
  # size: 8Gi